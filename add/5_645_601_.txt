<link href="../ochered/styleo.css" rel="stylesheet" type="text/css">
<input type="hidden" name="date_" value="@D30008501TR">
<input type="hidden" name="time_" value="@D30008601TR">
<input type="hidden" name="doct_" value="@D30008701TR">
<input type="hidden" name="s_print" value="@D30008901TR">
<input type="hidden" name="RaspToKab" value="@D3001046010">
<style>
.btn_back {
  text-decoration: none;
  outline: none;
  display: inline-block;
  padding: 12px 40px;
  border-radius: 30px;
  background-image: linear-gradient(45deg, #6ab1d7 0%, #33d9de 50%, #002878 100%);
  background-position: 100% 0;
  background-size: 200% 200%;
  font-family: 'Montserrat', sans-serif;
  font-size: calc(22px + 16 * (100vw / 1280));
  font-weight: bold 300;
  color: white;
  box-shadow: 0 16px 32px 0 rgba(0,40,120,.35);
  position: fixed; 
  bottom: 5px;
  left: 35px; 
}
</style>
<div class="noselect">
<input type="hidden" name="sAdres_start" id="sAdres_start"  value="@D30010101TR">
<h3>Авторизация с помощью штрих-кода</h3>
<h4>Пожалуйста, поднесите карту ?Электронный рецепт? к считывающему устройству</h4>
<div>
 <input type="input" class="" style="padding:5px;margin:5px;width:50%;height:100%;font-size:24px;" name="num_pac" id="num_pac" onChange="@D30009001TR"><br>
 <img src="../ochered/kartaER.jpg" class="kartEr" width="440" height="220">
 <input type="button" class="btn_back"  value="Назад"  onclick=" history.back();" >
  <div class="uzfoot" >
 
 <input class="r" value="Выйти"  onclick="document.f_10_02_2_1.action='@D30010101TR';document.f_10_02_2_1.submit();" type="button">
</div>
<script language="JavaScript" type="text/JavaScript">
document.f_10_02_2_1.num_pac.focus();

setTimeout(function() {
document.f_10_02_2_1.action='@D30010101TR';
document.f_10_02_2_1.submit();
}, 30000);
//-->
</script>
###<!--2-->
<div style="text-align:center;">
<a href="#" class="loader" id="page_load">@D3000660000</a>
</div>
<script language="JavaScript" type="text/JavaScript">
setTimeout(function() {
document.f_10_02_2_1.action='@D30010101TR';
document.f_10_02_2_1.submit();
}, 6000);
//-->
</script>
###
<input type="hidden" name="date_" value="@D30008501TR">
<input type="hidden" name="time_" value="@D30008601TR">
<input type="hidden" name="doct_" value="@D30008701TR">
<input type="hidden" name="RaspToKab" value="@D3001046010">
<input type="hidden" name="num_pac" value="@D30008001TR">
<input type="hidden" name="kod_f" value="@D30008101TR">
<input type="hidden" name="kod_kart" value="@D3000826016">
<input type="hidden" name="num_kart" value="@D30008301TR">
<input type="hidden" name="s_print" value="@D30008901TR">
<input type="hidden" name="sAdres_start" id="sAdres_start"  value="@D30010101TR">
<script language="JavaScript" type="text/JavaScript">
@D30009101TR
</script>


#PROGRAM:
LOCAL cSql := ''
*?a003_,aPar_

DO WHILE .T.
	a001_[01] := CT6_209_(aPar_,'sAdres_start')
	a001_[04] := VAL(CT6_209_(aPar_,'RaspToKab'))
	a000_[80] := alltrim(CT6_209_(aPar_,'num_pac'))  //номер штрихкода
	a000_[85] := CT6_209_(aPar_,"date_")
	a000_[86] := CT6_209_(aPar_,"time_")
	a000_[87] := CT6_209_(aPar_,"doct_")
	a000_[89] := CT6_209_(aPar_,'s_print')
	a000_[90] := ''
	a000_[91] := 'jsa_031(5,645,609);'
	IF a001_[04]>0
		a000_[90] := 'document.f_10_02_2_1.submit();'
		a000_[91] := 'jsa_031(5,645,611);'
	ENDIF
	IF a000_[80]=='0NO0' .OR. EMPTY(a000_[80])
? AT0_001_(XP:PART[1])
		EXIT
	ENDIF
*вход по штрих-коду	
	IF LEN(a000_[80]) = 16
		cSql = "SELECT T301__02 FROM T301 WHERE T301__01=440 AND T301__03="+SUBSTR(a000_[80],9)+" AND T301__09="+SUBSTR(a000_[80],1,8)+" AND T301__98=0"
		aTmp := {}
		IF .NOT. CheckResult(CT12_219_(hPipe,cSql,aTmp))	
			a000_[66]:= "<p>ОШИБКА:<br>Int.err - попробуйте еще раз! Возврат через 3 сек...</p>"
? AT0_001_(XP:PART[02])	
			EXIT
		ENDIF
		IF LEN(aTmp) = 0  // нет в базе данных
			a000_[66]:= "<h3>Карточка не зарегистрирована в системе, обратитесь в регистратуру.</h3>"
? AT0_001_(XP:PART[2])
			EXIT
		ENDIF
		a000_[81] := zstr(aTmp[1])		//T300__01 пациента
		cSql = "SELECT T130__01,T130__07 FROM T130 WHERE T130__03="+a000_[81]+" AND T130__04=310 AND T130__08="+a998_[18]+" AND T130__97="+ZSTR(a999_[22])+" AND T130__98=0"
		
		aTmp_ := {}
		IF .NOT. CheckResult(CT12_219_(hPipe,cSql,aTmp_))	
			a000_[66]:= "<p>ОШИБКА:<br>Int.err - попробуйте еще раз! Возврат через 3 сек...</p>"
? AT0_001_(XP:PART[02])	
			EXIT
		ENDIF
		IF LEN(aTmp_) = 0  // нет в базе данных
			a000_[66]:= "<h3>Не заключён договор с пациентом, обратитесь в регистратуру.</h3>"
? AT0_001_(XP:PART[2])
			EXIT
		ENDIF
		a000_[82]:= aTmp_[1]
		a000_[83]:= aTmp_[2]
	ELSE
		a000_[66]:='Не верен формат карты ?Электронный рецепт?'+a000_[80] //'<h3>Воспользуйтесь картой ?Электронный рецепт?.</h3>'
? AT0_001_(XP:PART[2])
? AT0_001_(XP:PART[1])
		EXIT
	ENDIF  
? AT0_001_(XP:PART[3])
	
	EXIT
ENDDO
		
	